<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Consulta Pedagógica do Estudante</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  max-width: 700px;
  margin: auto;
  padding: 20px;
}

h2 {
  text-align: center;
}

select, input, button {
  width: 100%;
  padding: 10px;
  margin: 8px 0;
}

button {
  background: #1976d2;
  color: white;
  border: none;
  cursor: pointer;
}

button:hover {
  background: #0d47a1;
}

.card {
  border: 1px solid #ccc;
  padding: 15px;
  margin-top: 20px;
}
</style>
</head>

<body>

<h2>Consulta de Notas e Fluência Leitora</h2>

<label>Turma</label>
<select id="turma">
  <option value="">Selecione</option>
  <option value="5anoc">5anoc</option>
  <option value="5A">5A</option>
</select>

<label>RA do estudante</label>
<input id="ra" placeholder="Digite o RA">

<button onclick="consultar()">Consultar</button>

<div id="resultado"></div>

<script>
async function carregarTurma(turma) {
  // remove script anterior
  const antigo = document.getElementById("dadosTurma");
  if (antigo) antigo.remove();

  return new Promise((resolve, reject) => {
    const script = document.createElement("script");
    script.src = `dados-${turma}.html`; // arquivo gerado pelo espelho
    script.id = "dadosTurma";
    script.onload = () => resolve();
    script.onerror = () => reject();
    document.body.appendChild(script);
  });
}

async function consultar() {
  const turma = document.getElementById("turma").value;
  const ra = document.getElementById("ra").value.trim();
  const resultado = document.getElementById("resultado");
  resultado.innerHTML = "";

  if (!turma || !ra) {
    resultado.innerHTML = "Informe a turma e o RA.";
    return;
  }

  try {
    await carregarTurma(turma);
  } catch {
    resultado.innerHTML = "Arquivo de dados da turma não encontrado.";
    return;
  }

  if (typeof DADOS_TURMA === "undefined") {
    resultado.innerHTML = "Dados da turma inválidos.";
    return;
  }

  const registro = DADOS_TURMA.find(r => r.ra === ra);
  if (!registro) {
    resultado.innerHTML = "RA não encontrado nesta turma.";
    return;
  }

  try {
    const bytes = CryptoJS.AES.decrypt(registro.dados, ra);
    const aluno = JSON.parse(bytes.toString(CryptoJS.enc.Utf8));

    resultado.innerHTML = `
      <div class="card">
        <h3>${aluno.nome}</h3>
        <p><strong>Turma:</strong> ${aluno.turma}</p>

        <h4>Notas</h4>
        <ul>
          <li>Matemática: ${aluno.notas.MAT || "-"}</li>
          <li>Língua Portuguesa: ${aluno.notas.LP || "-"}</li>
          <li>História: ${aluno.notas.HIS || "-"}</li>
          <li>Geografia: ${aluno.notas.GEO || "-"}</li>
          <li>Ciências: ${aluno.notas.CIE || "-"}</li>
          <li>Educação Física: ${aluno.notas.EF || "-"}</li>
        </ul>

        <h4>Fluência Leitora</h4>
        <p><strong>Nível:</strong> ${aluno.fluencia.nivel}</p>
        <p>${aluno.fluencia.observacoes || ""}</p>
      </div>
    `;
  } catch {
    resultado.innerHTML = "Erro ao descriptografar os dados. Verifique o RA.";
  }
}
</script>

</body>
</html>
