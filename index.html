<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Consulta Escolar</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<style>
body{
  font-family:Arial, sans-serif;
  max-width:720px;
  margin:auto;
  padding:20px;
}
input, button{
  width:100%;
  padding:10px;
  margin-top:10px;
  font-size:16px;
}
button{
  background:#2563eb;
  color:#fff;
  border:none;
  cursor:pointer;
}
.card{
  border:1px solid #ccc;
  padding:15px;
  margin-top:20px;
  border-radius:8px;
}
</style>
</head>

<body>

<h2>Consulta de Notas do Estudante</h2>

<input id="turma" placeholder="Digite a turma (ex: 5A)">
<input id="nome" placeholder="Digite o nome completo do estudante">
<button onclick="consultar()">Consultar</button>

<div id="resultado"></div>

<script>
let DADOS_TURMA = null;

function carregarArquivoTurma(turma, callback){
  const antigo = document.getElementById("dadosTurma");
  if(antigo) antigo.remove();

  const turmaNormalizada = turma.trim().toUpperCase();
  const script = document.createElement("script");
  script.id = "dadosTurma";
  script.src = `${turmaNormalizada}/dados.js`;

  script.onload = callback;
  script.onerror = () => {
    document.getElementById("resultado").innerHTML =
      "Arquivo da turma não encontrado.";
  };

  document.body.appendChild(script);
}

function consultar(){
  const turma = document.getElementById("turma").value;
  const nomeDigitado = document.getElementById("nome").value.trim().toLowerCase();
  const resultado = document.getElementById("resultado");

  resultado.innerHTML = "";

  if(!turma || !nomeDigitado){
    resultado.innerHTML = "Informe a turma e o nome do estudante.";
    return;
  }

  carregarArquivoTurma(turma, () => {

    if(!Array.isArray(DADOS_TURMA)){
      resultado.innerHTML = "Dados da turma inválidos.";
      return;
    }

    const aluno = DADOS_TURMA.find(
      a => a.nome.toLowerCase() === nomeDigitado
    );

    if(!aluno){
      resultado.innerHTML = "Estudante não encontrado.";
      return;
    }

    try{
      const bytes = CryptoJS.AES.decrypt(aluno.dados, nomeDigitado);
      const dados = JSON.parse(bytes.toString(CryptoJS.enc.Utf8));

      resultado.innerHTML = `
      <div class="card">
        <h3>${dados.nome}</h3>
        <strong>Turma:</strong> ${dados.turma}<br><br>

        <h4>Médias Anuais</h4>
        <ul>
          <li>Língua Portuguesa: ${dados.medias.LP}</li>
          <li>Arte: ${dados.medias.ARTE}</li>
          <li>Educação Física: ${dados.medias.EF}</li>
          <li>Ensino Religioso: ${dados.medias.ER}</li>
          <li>Matemática: ${dados.medias.MAT}</li>
          <li>Geografia: ${dados.medias.GEO}</li>
          <li>História: ${dados.medias.HIS}</li>
          <li>Ciências: ${dados.medias.CIE}</li>
        </ul>

        <strong>Total de Faltas:</strong> ${dados.faltas || "-"}
      </div>`;
    }catch{
      resultado.innerHTML = "Erro ao descriptografar os dados.";
    }
  });
}
</script>

</body>
</html>
